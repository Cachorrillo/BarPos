@page "{id:long}"
@model BarPos.Pages.POS.DetallesModel
@{
    ViewData["Title"] = "Detalle de Cuenta";
}

<h2 class="text-center mb-4">🧾 Detalle de Cuenta - @Model.Cuenta.NombreCliente</h2>

<div class="d-flex justify-content-between mb-3">
    <a asp-page="Index" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Volver al POS
    </a>
    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalAgregar">
        <i class="bi bi-cart-plus"></i> Agregar Producto
    </button>
</div>

@if (Model.Detalles.Count == 0)
{
    <div class="alert alert-info text-center">
        No hay productos en esta cuenta.
    </div>
}
else
{
    <table class="table table-striped table-bordered text-center align-middle">
        <thead class="table-dark">
            <tr>
                <th>Producto</th>
                <th>Presentación</th>
                <th>Cantidad</th>
                <th>Precio Unitario (₡)</th>
                <th>Subtotal (₡)</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var d in Model.Detalles)
            {
                <tr>
                    <td>@(d.Producto?.Nombre ?? d.Presentacion?.Producto?.Nombre ?? "Desconocido")</td>

                    <td>@(d.Presentacion?.Nombre ?? "-")</td>
                    <td>@d.Cantidad</td>
                    <td>@d.PrecioUnitario.ToString("N2")</td>
                    <td>@((d.PrecioUnitario * d.Cantidad).ToString("N2"))</td>





                </tr>
            }
        </tbody>
    </table>

    <div class="text-end fw-bold fs-5">
        Total: ₡@Model.Cuenta.Total.ToString("N2")
    </div>
}

<!-- 🧾 Modal de selección de producto -->
<div class="modal fade" id="modalAgregar" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">

            <!-- ✅ Form corregido (ruta exacta y segura) -->
            <form method="post" asp-page-handler="Agregar" asp-route-id="@Model.Cuenta.Id">


                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title" id="modalLabel">Seleccionar Producto</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <!-- Categorías -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Categoría:</label>
                        <div class="d-flex flex-wrap gap-2">
                            @foreach (var c in (IEnumerable<BarPos.Models.Categoria>)ViewData["Categorias"])
                            {
                                <button type="button" class="btn btn-outline-primary btn-sm categoria-btn"
                                        data-id="@c.Id" data-nombre="@c.Nombre">
                                    @c.Nombre
                                </button>
                            }
                        </div>
                    </div>

                    <!-- Productos -->
                    <div id="contenedorProductos" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                        <p class="text-muted text-center">Seleccione una categoría para ver los productos...</p>
                    </div>

                    <!-- Presentaciones (solo licores) -->
                    <div id="seccionPresentaciones" class="mt-3" style="display:none;">
                        <label class="form-label fw-bold">Presentación:</label>
                        <select id="PresentacionId" name="PresentacionId" class="form-select">
                            <option value="">-- Seleccione una presentación --</option>
                        </select>
                    </div>

                    <!-- ✅ Campo oculto para ProductoId -->
                    <input type="hidden" id="ProductoId" name="ProductoId" value="0" />

                    <!-- Cantidad -->
                    <div class="mt-3">
                        <label for="Cantidad" class="form-label fw-bold">Cantidad:</label>
                        <input asp-for="Cantidad" class="form-control" type="number" min="1" value="1" />
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-circle"></i> Agregar a la cuenta
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {

            let categoriaSeleccionada = "";
            let productoSeleccionado = "";

            // 🔹 Al hacer clic en una categoría
            $(".categoria-btn").click(function () {
                categoriaSeleccionada = $(this).data("nombre");
                const categoriaId = $(this).data("id");

                $(".categoria-btn").removeClass("btn-primary").addClass("btn-outline-primary");
                $(this).removeClass("btn-outline-primary").addClass("btn-primary");

                $("#contenedorProductos").html("<p class='text-muted text-center'>Cargando productos...</p>");

                $.getJSON(`?handler=ProductosPorCategoria&categoriaId=${categoriaId}`, function (data) {
                    if (data.length === 0) {
                        $("#contenedorProductos").html("<p class='text-center text-danger'>No hay productos en esta categoría.</p>");
                        return;
                    }

                    let html = "<div class='d-flex flex-wrap gap-2 justify-content-start'>";
                    $.each(data, function (i, producto) {
                        html += `<button type="button" class="btn btn-outline-dark producto-btn"
                                    data-id="${producto.id}" data-nombre="${producto.nombre}">
                                    ${producto.nombre}
                                 </button>`;
                    });
                    html += "</div>";

                    $("#contenedorProductos").html(html);
                    $("#seccionPresentaciones").hide();
                });
            });

            // 🔹 Al seleccionar un producto
            $(document).on("click", ".producto-btn", function () {
                productoSeleccionado = $(this).data("nombre");
                const productoId = $(this).data("id");

                // ✅ Guardar el producto seleccionado en el input oculto
                $("#ProductoId").val(productoId);

                $(".producto-btn").removeClass("btn-dark").addClass("btn-outline-dark");
                $(this).removeClass("btn-outline-dark").addClass("btn-dark");

                if (categoriaSeleccionada.toLowerCase() === "licores") {
                    $("#seccionPresentaciones").show();
                    $("#PresentacionId").html("<option>Cargando presentaciones...</option>");

                    $.getJSON(`?handler=PresentacionesPorProducto&productoId=${productoId}`, function (data) {
                        $("#PresentacionId").empty().append('<option value="">-- Seleccione una presentación --</option>');
                        $.each(data, function (i, pres) {
                            $("#PresentacionId").append(`<option value="${pres.id}">${pres.nombre} - ₡${pres.precioVenta.toFixed(2)}</option>`);
                        });
                    });
                } else {
                    $("#seccionPresentaciones").hide();
                    $("#PresentacionId").html('<option value="">-- N/A --</option>');
                }
            });
        });
    </script>
}
